{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark-blue">Petty Cash Management</h2>
                <p class="text-muted mb-0">Track Daily Office Income & Expenses</p>
            </div>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary rounded-pill"><i
                    class="fas fa-arrow-left me-1"></i> Back to Dashboard</a>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 bg-success bg-opacity-10">
                    <div class="card-body text-center p-3">
                        <div class="small fw-bold text-success text-uppercase">Total Income</div>
                        <div class="h3 fw-bold text-dark mb-0">${{ "{:,.0f}".format(total_income) }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 bg-warning bg-opacity-10">
                    <div class="card-body text-center p-3">
                        <div class="small fw-bold text-warning text-uppercase">Total Expense</div>
                        <div class="h3 fw-bold text-dark mb-0">${{ "{:,.0f}".format(total_expense) }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100 bg-primary bg-opacity-10">
                    <div class="card-body text-center p-3">
                        <div class="small fw-bold text-primary text-uppercase">Cash in Hand</div>
                        <div class="h3 fw-bold text-dark mb-0">${{ "{:,.0f}".format(current_balance) }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h5 class="fw-bold text-dark mb-0"><i class="fas fa-history me-2"></i>History</h5>
                            
                            <!-- Actions & Filter -->
                            <div class="d-flex gap-2 align-items-center flex-wrap">
                                <!-- Add Button -->
                                <button type="button" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="openAddModal()">
                                    <i class="fas fa-plus me-1"></i> Add Entry
                                </button>
                                
                                <div class="vr mx-1"></div>

                                <!-- Filter Form -->
                                <form method="GET" action="{{ url_for('main.manage_petty_cash') }}" class="d-flex gap-2 align-items-center">
                                    <input type="date" name="start_date" class="form-control form-control-sm" value="{{ request.args.get('start_date', '') }}" title="Start Date">
                                    <span class="text-muted">-</span>
                                    <input type="date" name="end_date" class="form-control form-control-sm" value="{{ request.args.get('end_date', '') }}" title="End Date">
                                    
                                    <select name="category" class="form-select form-select-sm" style="width: 130px;">
                                        <option value="All">All Categories</option>
                                        <option value="Office" {% if request.args.get('category') == 'Office' %}selected{% endif %}>Office</option>
                                        <option value="Food" {% if request.args.get('category') == 'Food' %}selected{% endif %}>Food</option>
                                        <option value="Transport" {% if request.args.get('category') == 'Transport' %}selected{% endif %}>Transport</option>
                                        <option value="Salary" {% if request.args.get('category') == 'Salary' %}selected{% endif %}>Salary</option>
                                        <option value="Maintenance" {% if request.args.get('category') == 'Maintenance' %}selected{% endif %}>Maintenance</option>
                                        <option value="Other" {% if request.args.get('category') == 'Other' %}selected{% endif %}>Other</option>
                                    </select>
                                    
                                    <button type="submit" class="btn btn-sm btn-outline-primary"><i class="fas fa-filter"></i></button>
                                    <a href="{{ url_for('main.manage_petty_cash') }}" class="btn btn-sm btn-outline-secondary" title="Clear"><i class="fas fa-times"></i></a>
                                    
                                    <a href="{{ url_for('main.export_petty_cash_report', **request.args) }}" class="btn btn-sm btn-success text-white" title="Export Excel"><i class="fas fa-file-excel"></i></a>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0 mt-3">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light text-muted small text-uppercase">
                                    <tr>
                                        <th class="ps-4">Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Type</th>
                                        <th>Proof</th>
                                        <th class="text-end">Amount</th>
                                        <th class="text-end pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in entries %}
                                    <tr>
                                        <td class="ps-4 text-secondary">{{ entry.date }}</td>
                                        <td class="fw-bold text-dark">{{ entry.description }}</td>
                                        <td><span class="badge bg-light text-dark border">{{ entry.category }}</span></td>
                                        <td>
                                            {% if entry.type == 'Income' %}
                                            <span class="badge bg-success bg-opacity-10 text-success">INCOME</span>
                                            {% else %}
                                            <span class="badge bg-danger bg-opacity-10 text-danger">EXPENSE</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.images %}
                                            <div>
                                                {% for img in entry.images.split(',') %}
                                                    {% if img.lower().endswith('.pdf') %}
                                                        <a href="{{ url_for('static', filename='uploads/' + img) }}" target="_blank" class="text-danger me-1 fs-5" title="View PDF"><i class="fas fa-file-pdf"></i></a>
                                                    {% elif img.lower().endswith('.doc') or img.lower().endswith('.docx') %}
                                                        <a href="{{ url_for('static', filename='uploads/' + img) }}" class="text-primary me-1 fs-5" title="Download Doc"><i class="fas fa-file-word"></i></a>
                                                    {% else %}
                                                        <a href="{{ url_for('static', filename='uploads/' + img) }}" target="_blank" class="d-inline-block me-1">
                                                            <img src="{{ url_for('static', filename='uploads/' + img) }}" class="img-thumbnail rounded-circle" style="height: 30px; width: 30px; object-fit: cover;">
                                                        </a>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <span class="text-muted small">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end fw-bold {{ 'text-success' if entry.type == 'Income' else 'text-dark' }}">
                                            ${{ "{:,.0f}".format(entry.amount) }}
                                        </td>
                                        <td class="text-end pe-4">
                                            <a href="{{ url_for('main.invoice_view', id=entry.id) }}" class="btn btn-sm btn-outline-dark rounded-circle me-1" title="Print Invoice">
                                                <i class="fas fa-print"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-primary rounded-circle me-1" 
                                                    onclick="openEditModal('{{ entry.id }}', '{{ entry.date }}', '{{ entry.description }}', '{{ entry.category }}', '{{ entry.type }}', '{{ entry.amount }}')"
                                                    title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <a href="#" class="btn btn-sm btn-outline-danger rounded-circle" onclick="return confirmDelete(event, `{{ url_for('main.delete_petty_cash', id=entry.id) }}`)" title="Delete">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center py-5 text-muted">
                                            No records found.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Entry Modal -->
<div class="modal fade" id="entryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-bold" id="modalTitle">Add New Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="entryForm" method="POST" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Date</label>
                            <input type="date" name="date" id="inputDate" class="form-control" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Description</label>
                            <input type="text" name="description" id="inputDescription" class="form-control" placeholder="e.g. Office Rent" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Category</label>
                            <select name="category" id="inputCategory" class="form-select">
                                <option value="Office">Office</option>
                                <option value="Food">Food</option>
                                <option value="Transport">Transport</option>
                                <option value="Salary">Salary</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Type</label>
                            <select name="type" id="inputType" class="form-select">
                                <option value="Expense" selected>Expense</option>
                                <option value="Income">Income</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" name="amount" id="inputAmount" class="form-control" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="col-12">
                             <label class="form-label small fw-bold text-muted">Evidence (Images/PDF/Doc)</label>
                             <input type="file" name="evidence" class="form-control" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx">
                             <div id="editEvidenceNote" class="form-text text-muted d-none">Upload new files to append to existing ones.</div>
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100 fw-bold py-2" id="modalSubmitBtn">Add Entry</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Ensure Bootstrap is loaded
    var entryModal;
    document.addEventListener("DOMContentLoaded", function(){
        entryModal = new bootstrap.Modal(document.getElementById('entryModal'));
    });

    function openAddModal() {
        document.getElementById('modalTitle').innerText = 'Add New Entry';
        document.getElementById('modalSubmitBtn').innerText = 'Add Entry';
        document.getElementById('entryForm').action = "{{ url_for('main.manage_petty_cash') }}";
        document.getElementById('editEvidenceNote').classList.add('d-none');
        
        // Clear fields
        document.getElementById('inputDate').value = new Date().toISOString().slice(0, 10);
        document.getElementById('inputDescription').value = '';
        document.getElementById('inputCategory').value = 'Office';
        document.getElementById('inputType').value = 'Expense';
        document.getElementById('inputAmount').value = '';
        
        entryModal.show();
    }

    function openEditModal(id, date, description, category, type, amount) {
        document.getElementById('modalTitle').innerText = 'Edit Entry';
        document.getElementById('modalSubmitBtn').innerText = 'Update Entry';
        
        // Construct Edit Action URL
        document.getElementById('entryForm').action = "/petty_cash/edit/" + id;
        
        document.getElementById('editEvidenceNote').classList.remove('d-none');

        // Populate fields
        document.getElementById('inputDate').value = date;
        document.getElementById('inputDescription').value = description;
        document.getElementById('inputCategory').value = category;
        document.getElementById('inputType').value = type;
        document.getElementById('inputAmount').value = amount;

        entryModal.show();
    }
</script>
{% endblock %}