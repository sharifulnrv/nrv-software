{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-dark-blue">Dashboard</h2>
        <p class="text-muted mb-0">Overview of Company Financials</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('main.manage_petty_cash') }}" class="btn btn-outline-primary rounded-pill">
            <i class="fas fa-coins me-2"></i>Petty Cash
        </a>
        <a href="{{ url_for('main.download_all_customers_report') }}" class="btn btn-outline-success rounded-pill">
            <i class="fas fa-file-excel me-2"></i>Export All
        </a>
        <div class="input-group">
            <input type="text" class="form-control" id="searchBar" placeholder="Search customers...">
            <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
        </div>
        <a href="{{ url_for('main.change_password_request') }}" class="btn btn-light rounded-circle border shadow-sm" title="Change Password">
            <i class="fas fa-key text-warning"></i>
        </a>
        <a href="{{ url_for('main.settings') }}" class="btn btn-light rounded-circle border shadow-sm" title="Settings">
            <i class="fas fa-cog text-secondary"></i>
        </a>
    </div>
</div>



<!-- Grand Summary (Directors) -->
<div class="row mb-2">
    <div class="col-12">
        <h5 class="text-muted small text-uppercase fw-bold ps-1">Directors Summary</h5>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 bg-primary bg-opacity-10">
            <div class="card-body text-center p-3">
                <div class="text-uppercase small fw-bold text-primary mb-1">Total Payable (Directors)</div>
                <div class="fs-2 fw-bold text-dark">${{ "{:,.0f}".format(grand_total_payable) }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 bg-success bg-opacity-10">
            <div class="card-body text-center p-3">
                <div class="text-uppercase small fw-bold text-success mb-1">Total Paid (Directors)</div>
                <div class="fs-2 fw-bold text-dark">${{ "{:,.0f}".format(grand_total_paid) }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 bg-danger bg-opacity-10">
            <div class="card-body text-center p-3">
                <div class="text-uppercase small fw-bold text-danger mb-1">Total Due (Directors)</div>
                <div class="fs-2 fw-bold text-dark">${{ "{:,.0f}".format(grand_total_due) }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Grand Summary (Customers) -->
<div class="row mb-5">
    <div class="col-12">
        <h5 class="text-muted small text-uppercase fw-bold ps-1">Customers Summary</h5>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 bg-info bg-opacity-10">
            <div class="card-body text-center p-3">
                <div class="text-uppercase small fw-bold text-info mb-1">Total Price (Customers)</div>
                <div class="fs-2 fw-bold text-dark">${{ "{:,.0f}".format(cust_total_payable) }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 bg-success bg-opacity-10">
            <div class="card-body text-center p-3">
                <div class="text-uppercase small fw-bold text-success mb-1">Total Paid (Customers)</div>
                <div class="fs-2 fw-bold text-dark">${{ "{:,.0f}".format(cust_total_paid) }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 bg-warning bg-opacity-10">
            <div class="card-body text-center p-3">
                <div class="text-uppercase small fw-bold text-warning mb-1">Total Due (Customers)</div>
                <div class="fs-2 fw-bold text-dark">${{ "{:,.0f}".format(cust_total_due) }}</div>
            </div>
        </div>
    </div>
</div>

{% if not directors %}
<div class="text-center py-5">
    <div class="mb-3 text-muted display-1"><i class="fas fa-folder-open"></i></div>
    <h4>No Directors Found</h4>
    <p class="text-muted">Start by adding a Director to the system.</p>
    <a href="{{ url_for('main.add_director') }}" class="btn btn-primary btn-lg rounded-pill shadow-sm">Add Director</a>
</div>
{% else %}

<div class="accordion" id="directorsAccordion">
    {% for director in directors %}
    <div class="accordion-item mb-3 shadow-sm border-0 rounded overflow-hidden">
        <h2 class="accordion-header" id="heading{{ director.id }}">
            <div class="d-flex align-items-center w-100">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %} fw-semibold" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse{{ director.id }}"
                    aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse{{ director.id }}">
                    <span class="d-flex align-items-center">
                        <i class="fas fa-user-tie me-2 text-primary"></i> {{ director.name }}
                        <span class="badge bg-light text-dark ms-2 border">{{ director.customers|length }}
                            Customers</span>
                    </span>
                    <span class="ms-auto me-3 text-muted small">
                        <i class="fas fa-phone-alt me-1"></i> {{ director.phone }}
                    </span>
                    <a href="{{ url_for('main.download_director_customers_report', id=director.id) }}" 
                       class="btn btn-sm btn-outline-success me-3 rounded-pill" onclick="event.stopPropagation();">
                       <i class="fas fa-file-excel me-1"></i> Export List
                    </a>
                </button>
                <div class="border-bottom p-2 bg-light d-flex align-items-center" style="min-height: 100%;">
                    <a href="{{ url_for('main.edit_director', id=director.id) }}"
                        class="btn btn-sm btn-outline-secondary me-1 rounded-pill text-nowrap">Edit</a>
                    <a href="#" onclick="return confirmDelete(event, `{{ url_for('main.delete_director', id=director.id) }}`)"
                        class="btn btn-sm btn-outline-danger rounded-pill text-nowrap">Delete</a>
                </div>
            </div>
        </h2>
        <div id="collapse{{ director.id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
            aria-labelledby="heading{{ director.id }}" data-bs-parent="#directorsAccordion">
            <div class="accordion-body bg-light p-0">

                <!-- Director Financial Profile -->
                <div class="bg-white p-4 mb-3 border-bottom">
                    <div class="row g-3">
                        <div class="col-md-3 border-end">
                            <div class="text-muted small text-uppercase fw-bold mb-1">Director Details</div>
                            <div class="fw-bold fs-5 text-dark">{{ director.name }}</div>
                            <div class="text-muted"><i class="fas fa-university me-1"></i> {{ director.bank_name or
                                'N/A' }}</div>
                            <div class="text-muted small"><i class="fas fa-phone me-1"></i> {{ director.phone }}</div>
                        </div>
                        <div class="col-md-3 border-end">
                            <div class="text-muted small text-uppercase fw-bold mb-1">Share Info</div>
                            <div>Total Share: <strong>{{ director.total_share }}</strong></div>
                            <div>Per Share: ${{ "{:,.0f}".format(director.per_share_value) }}</div>
                            <div>Fair Cost: ${{ "{:,.0f}".format(director.fair_cost) }}</div>
                            <div class="text-primary fw-bold mt-1">
                                Value: ${{ "{:,.0f}".format(director.total_share * director.per_share_value) }}
                            </div>
                        </div>
                        <div class="col-md-3 border-end">
                            <div class="text-muted small text-uppercase fw-bold mb-1">Assets & Dues</div>
                            <div>Extra Land: ${{ "{:,.0f}".format(director.land_value_extra_share) }}</div>
                            <div class="mt-2 text-muted small text-uppercase fw-bold">Total Payable</div>
                            {% set total_share_val = director.total_share * director.per_share_value %}
                            <div class="fw-bold text-dark">${{ "{:,.0f}".format(total_share_val +
                                director.land_value_extra_share) }}</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-muted small text-uppercase fw-bold mb-1">Payment Status</div>
                            <div class="d-flex justify-content-between">
                                <span>Paid:</span>
                                <span class="text-success fw-bold">${{ "{:,.0f}".format(director.total_paid) }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Due:</span>
                                {% set total_payable = total_share_val + director.land_value_extra_share %}
                                <span class="text-danger fw-bold">${{ "{:,.0f}".format(total_payable -
                                    director.total_paid) }}</span>
                            </div>
                            <div class="mt-2 small text-muted border-top pt-2">
                                <div class="fw-bold text-uppercase" style="font-size: 0.75rem;">Payment History:</div>
                                <div style="max-height: 60px; overflow-y: auto; white-space: pre-wrap;">{{
                                    director.payment_history or 'No history' }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if director.customers %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-white text-muted small text-uppercase">
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Plot</th>
                                <th>Total</th>
                                <th>Paid</th>
                                <th>Due</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in director.customers %}
                            <tr class="searchable-row">
                                <td class="ps-4 fw-medium text-secondary">{{ customer.customer_id }}</td>
                                <td class="fw-bold text-dark">{{ customer.name }}</td>
                                <td>{{ customer.phone }}</td>
                                <td><span
                                        class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">{{
                                        customer.plot_no }}</span></td>
                                <td class="text-secondary">{{ "{:,.0f}".format(customer.total_price) }}</td>
                                <td class="text-success fw-semibold">{{ "{:,.0f}".format(customer.total_paid) }}</td>
                                <td class="text-danger fw-semibold">{{ "{:,.0f}".format(customer.due_amount) }}</td>
                                <td class="text-end pe-4">
                                    <a href="{{ url_for('main.manage_transactions', customer_id=customer.id) }}"
                                        class="text-info me-3" title="Transactions"><i class="fas fa-receipt"></i></a>
                                    <a href="{{ url_for('main.edit_customer', id=customer.id) }}"
                                        class="text-primary me-3" title="Edit"><i class="fas fa-edit"></i></a>
                                    <a href="{{ url_for('main.delete_customer', id=customer.id) }}" class="text-danger"
                                        title="Delete" onclick="return confirmDelete(event, `{{ url_for('main.delete_customer', id=customer.id) }}`)"><i
                                            class="fas fa-trash-alt"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="bg-white fw-bold border-top">
                                <td colspan="4" class="text-end">Subtotal:</td>
                                <td class="text-secondary">{{
                                    "{:,.0f}".format(director.customers|sum(attribute='total_price')) }}</td>
                                <td class="text-success">{{
                                    "{:,.0f}".format(director.customers|sum(attribute='total_paid')) }}</td>
                                <td class="text-danger">{{
                                    "{:,.0f}".format(director.customers|sum(attribute='due_amount')) }}</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    No customers added for this director yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    document.getElementById('searchBar').addEventListener('keyup', function () {
        let value = this.value.toLowerCase().trim();
        let directors = document.querySelectorAll('.accordion-item');

        directors.forEach(function (director) {
            let rows = director.querySelectorAll('.searchable-row');
            let hasMatch = false;

            // 1. Filter Rows (Customers)
            rows.forEach(function (row) {
                let text = row.textContent.toLowerCase();
                if (value === '' || text.indexOf(value) > -1) {
                    row.style.display = ''; // Show row
                    if (value !== '') hasMatch = true; 
                } else {
                    row.style.display = 'none'; // Hide row
                }
            });

            // 2. Handle Director Visibility & Accordion State
            let collapseDiv = director.querySelector('.accordion-collapse');
            
            if (value === '') {
                // Reset: Show all directors
                director.style.display = '';
                // Optional: We don't force collapse here to preserve state, 
                // or we could revert to original state if tracked. 
                // For simplicity, we leave the expansion state as is when clearing.
            } else {
                if (hasMatch) {
                    director.style.display = ''; // Show director
                    // Auto-Expand if hidden
                    if (collapseDiv && !collapseDiv.classList.contains('show')) {
                        new bootstrap.Collapse(collapseDiv, { toggle: false }).show();
                    }
                } else {
                    director.style.display = 'none'; // Hide director if no customer matches
                    // Optional: Collapse it to be tidy?
                    // if (collapseDiv && collapseDiv.classList.contains('show')) {
                    //    new bootstrap.Collapse(collapseDiv, { toggle: false }).hide();
                    // }
                }
            }
        });
    });
</script>

{% endif %}
{% endblock %}